<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
</head>
<body>
  <h2>Chat Room</h2>
  <div id="c" style="width:400px;height:240px;border:1px solid #ccc;overflow:auto;padding:8px"></div>
  <input type="text" id="m" placeholder="Type message..." />
  <button onclick="send()">Send</button>

  <script>
  const c = document.getElementById("c");
  const m = document.getElementById("m");
  const host = location.hostname || 'localhost';
  const port = 6789;
  const ws = new WebSocket(`ws://${host}:${port}`);

  // maintain a mapping of message id -> element so deletions are easy
  const msgMap = new Map();
  // keep message text by id to render replies
  const textMap = new Map();

    function addMessage(id, text, reply_to) {
      const el = document.createElement('div');
      el.id = 'm-' + id;
      el.style.display = 'flex';
      el.style.justifyContent = 'space-between';
      el.style.alignItems = 'center';
      el.style.padding = '4px 0';

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.flexDirection = 'column';

      const meta = document.createElement('span');
      meta.textContent = `[${id}]`;
      meta.style.fontWeight = '600';

      const txt = document.createElement('span');
      txt.textContent = text;

      left.appendChild(meta);

      // if this message is a reply, show a small quoted preview
      if (reply_to != null) {
        const preview = document.createElement('div');
        preview.style.fontSize = '0.85em';
        preview.style.color = '#555';
        preview.style.borderLeft = '2px solid #ddd';
        preview.style.paddingLeft = '6px';
        preview.style.marginBottom = '4px';
        const orig = textMap.get(reply_to);
        preview.textContent = `â†ª Reply to [${reply_to}]: ${orig ?? '(deleted)'}`;
        left.appendChild(preview);
      }

      left.appendChild(txt);

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '6px';

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => ws.send(`/delete ${id}`);

      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.onclick = () => {
        // prefill reply command
        m.value = `/reply ${id} `;
        m.focus();
      };

      actions.appendChild(replyBtn);
      actions.appendChild(delBtn);

      el.appendChild(left);
      el.appendChild(actions);
      c.appendChild(el);
      msgMap.set(id, el);
      textMap.set(id, text);
      // auto-scroll
      c.scrollTop = c.scrollHeight;
    }

    function removeMessage(id) {
      const el = msgMap.get(id);
      if (el) {
        el.remove();
        msgMap.delete(id);
        textMap.delete(id);
      }
    }

    ws.onmessage = e => {
      let obj;
      try {
        obj = JSON.parse(e.data);
      } catch (err) {
        // fall back to plain text
        const el = document.createElement('div');
        el.textContent = e.data;
        c.appendChild(el);
        return;
      }

      if (obj.type === 'init') {
        c.innerHTML = '';
        msgMap.clear();
        textMap.clear();
        for (const m of obj.messages) {
          addMessage(m.id, m.text, m.reply_to ?? null);
        }
      } else if (obj.type === 'message') {
        addMessage(obj.id, obj.text, obj.reply_to ?? null);
      } else if (obj.type === 'delete') {
        removeMessage(obj.id);
      }
    };

    function send() {
      const txt = m.value.trim();
      if (!txt) return;
      ws.send(txt);
      m.value = "";
    }
  </script>
</body>
</html>