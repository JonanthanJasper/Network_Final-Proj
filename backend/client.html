<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
</head>
<body>
  <h2>Chat Room</h2>
  <div style="display:flex;gap:12px">
    <div style="width:240px">
      <div><strong>Your ID:</strong> <span id="myid">(connecting...)</span></div>
      <h4>Clients</h4>
      <div id="clients" style="height:120px;overflow:auto;border:1px solid #ddd;padding:4px"></div>
    </div>
    <div style="flex:1">
      <div id="c" style="width:100%;height:240px;border:1px solid #ccc;overflow:auto;padding:8px"></div>
      <input type="text" id="m" placeholder="Type message..." style="width:70%" />
      <button onclick="send()">Send</button>
    </div>
  </div>

  <script>
  const c = document.getElementById("c");
  const m = document.getElementById("m");
  const myidSpan = document.getElementById('myid');
  const clientsDiv = document.getElementById('clients');
  const host = location.hostname || 'localhost';
  const port = 6789;
  const ws = new WebSocket(`ws://${host}:${port}`);

  // maintain a mapping of message id -> element so deletions are easy
  const msgMap = new Map();
  // keep message text by id to render replies
  const textMap = new Map();

  function addMessage(id, text, reply_to) {
      // enhanced display: show sender/recipient if present
      const fromId = arguments[3];
      const fromName = arguments[4];
  const toId = arguments[5];
  const expiresAt = arguments[6];
      const el = document.createElement('div');
      el.id = 'm-' + id;
      el.style.display = 'flex';
      el.style.justifyContent = 'space-between';
      el.style.alignItems = 'center';
      el.style.padding = '4px 0';

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.flexDirection = 'column';

      const meta = document.createElement('span');
      meta.textContent = `[${id}]`;
      meta.style.marginRight = '8px';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';

      // show sender
      if (fromId) {
        const from = document.createElement('small');
        from.style.marginRight = '8px';
        from.textContent = `${fromName} (${fromId})`;
        header.appendChild(from);
      }

      header.appendChild(meta);
      meta.style.fontWeight = '600';

      const txt = document.createElement('span');
      txt.textContent = text;

  left.appendChild(header);

      // if this message is a reply, show a small quoted preview
      if (reply_to != null) {
        const preview = document.createElement('div');
        preview.style.fontSize = '0.85em';
        preview.style.color = '#555';
        preview.style.borderLeft = '2px solid #ddd';
        preview.style.paddingLeft = '6px';
        preview.style.marginBottom = '4px';
        const orig = textMap.get(reply_to);
        preview.textContent = `↪ Reply to [${reply_to}]: ${orig ?? '(deleted)'}`;
        left.appendChild(preview);
      }

      left.appendChild(txt);

      // if message was direct to someone, show marker
      if (toId) {
        const dm = document.createElement('div');
        dm.style.fontSize = '0.85em';
        dm.style.color = '#900';
        dm.textContent = `(direct to ${toId})`;
        left.appendChild(dm);
      }

      // if message expires, show expiry timestamp
      if (expiresAt) {
        const ex = document.createElement('div');
        ex.style.fontSize = '0.8em';
        ex.style.color = '#666';
        const d = new Date(expiresAt * 1000);
        ex.textContent = `(expires at ${d.toLocaleTimeString()})`;
        left.appendChild(ex);
      }

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '6px';

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => ws.send(`/delete ${id}`);

      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.onclick = () => {
        // prefill reply command
        m.value = `/reply ${id} `;
        m.focus();
      };

  actions.appendChild(replyBtn);
  actions.appendChild(delBtn);

      el.appendChild(left);
      el.appendChild(actions);
      c.appendChild(el);
      msgMap.set(id, el);
      textMap.set(id, text);
      // auto-scroll
      c.scrollTop = c.scrollHeight;
    }

    function removeMessage(id) {
      const el = msgMap.get(id);
      if (el) {
        el.remove();
        msgMap.delete(id);
        textMap.delete(id);
      }
    }

    let myId = null;

    function renderClients(list) {
      clientsDiv.innerHTML = '';
      for (const cli of list) {
        const btn = document.createElement('div');
        btn.style.padding = '4px';
        btn.style.cursor = 'pointer';
        btn.textContent = `${cli.name} — ${cli.id}`;
        btn.onclick = () => {
          m.value = `/to ${cli.id} `;
          m.focus();
        };
        clientsDiv.appendChild(btn);
      }
    }

    ws.onmessage = e => {
      let obj;
      try {
        obj = JSON.parse(e.data);
      } catch (err) {
        // fall back to plain text
        const el = document.createElement('div');
        el.textContent = e.data;
        c.appendChild(el);
        return;
      }

      if (obj.type === 'init') {
        // set own id/name
        if (obj.you) {
          myId = obj.you.id;
          myidSpan.textContent = `${obj.you.name} — ${obj.you.id}`;
        }
        c.innerHTML = '';
        msgMap.clear();
        textMap.clear();
        for (const mm of obj.messages) {
          addMessage(mm.id, mm.text, mm.reply_to ?? null, mm.from_id, mm.from_name, mm.to_id);
        }
        if (obj.clients) renderClients(obj.clients);
      } else if (obj.type === 'clients') {
        renderClients(obj.clients || []);
      } else if (obj.type === 'message') {
        addMessage(obj.id, obj.text, obj.reply_to ?? null, obj.from_id, obj.from_name, obj.to_id);
      } else if (obj.type === 'delete') {
        removeMessage(obj.id);
      }
    };

    function send() {
      const txt = m.value.trim();
      if (!txt) return;
      ws.send(txt);
      m.value = "";
    }
  </script>
</body>
</html>